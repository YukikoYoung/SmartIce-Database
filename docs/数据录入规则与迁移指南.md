# 野百灵餐饮集团 - 数据录入规则与迁移指南

**版本**: v1.0.0
**更新日期**: 2025-11-21
**适用范围**: MVP数据库初始化与数据迁移

---

## 📑 目录

1. [数据准备清单](#数据准备清单)
2. [文件1: 门店信息](#文件1-门店信息)
3. [文件2: 成本卡配方数据](#文件2-成本卡配方数据)
4. [文件3: 销售明细数据](#文件3-销售明细数据)
5. [文件4: 数据库配置](#文件4-数据库配置)
6. [数据质量检查](#数据质量检查)
7. [常见问题与解决方案](#常见问题与解决方案)
8. [导入流程](#导入流程)

---

## 数据准备清单

### 必须准备的文件(共4个)

| 文件编号 | 文件名 | 文件类型 | 数据来源 | 优先级 |
|---------|--------|---------|---------|--------|
| 文件1 | 门店信息.xlsx | Excel | 新建/手动整理 | ⭐⭐⭐ |
| 文件2 | 成本卡_标准格式.xlsx | Excel | 整理现有成本卡 | ⭐⭐⭐ |
| 文件3 | 销售明细_测试数据.xlsx | Excel | 复制9月销售数据 | ⭐⭐⭐ |
| 文件4 | 数据库配置.txt | 文本 | 新建 | ⭐⭐⭐ |

### 数据量预估

| 数据类型 | 预估数量 | 说明 |
|---------|---------|------|
| 品牌 | 2条 | 野百灵等品牌 |
| 门店 | 6条 | 德阳、绵阳等6家门店 |
| 产品(成品+半成品+原材料) | 200-300条 | 自动从成本卡提取 |
| 配方(recipe) | 63条 | 每个产品1个配方 |
| 配方明细(recipe_item) | 600-800条 | 每个配方5-15个原材料 |
| 原材料成本历史 | 150-200条 | 每个原材料1条当前单价 |
| 销售明细(1个月测试) | 3,000-10,000条 | 德阳店9月数据 |

---

## 文件1: 门店信息

### 基本信息

- **文件名**: `门店信息.xlsx`
- **文件格式**: Excel工作簿(.xlsx)
- **Sheet名称**: `门店清单`
- **数据行数**: 6行(6个门店)
- **编码格式**: UTF-8

### 必填字段定义

| 列序号 | 列名 | 数据类型 | 长度限制 | 示例值 | 是否必填 | 默认值 | 说明 |
|-------|------|---------|---------|--------|---------|--------|------|
| A | 门店名称 | 文本 | 1-200字符 | 野百灵德阳店 | ✅必填 | - | 门店全称,必须唯一 |
| B | 城市 | 文本 | 1-100字符 | 德阳市 | ✅必填 | - | 标准城市名称 |
| C | 省份 | 文本 | 1-100字符 | 四川省 | 推荐填 | - | 标准省份名称 |
| D | 地址 | 文本 | 1-500字符 | 德阳市旌阳区XX路XX号 | 推荐填 | - | 详细地址 |
| E | 开业日期 | 日期 | YYYY-MM-DD | 2023-06-01 | 推荐填 | - | 门店开业时间 |
| F | 营业状态 | 文本 | - | 营业中 | ✅必填 | 营业中 | 营业中/筹备中/暂停/关闭 |
| G | 店长姓名 | 文本 | 1-100字符 | 张三 | 可选 | - | 当前店长姓名 |
| H | 联系电话 | 文本 | 11位数字 | 13812345678 | 可选 | - | 门店联系电话 |

### 数据示例

```
门店名称          | 城市   | 省份   | 地址                        | 开业日期   | 营业状态 | 店长姓名 | 联系电话
野百灵德阳店      | 德阳市 | 四川省 | 德阳市旌阳区文庙广场XX号    | 2023-06-01 | 营业中   | 张三     | 13812345678
野百灵绵阳店      | 绵阳市 | 四川省 | 绵阳市涪城区临园路XX号      | 2023-08-01 | 营业中   | 李四     | 13987654321
野百灵成都春熙店  | 成都市 | 四川省 | 成都市锦江区春熙路XX号      | 2024-01-15 | 营业中   | 王五     | 13611112222
野百灵成都天府店  | 成都市 | 四川省 | 成都市高新区天府大道XX号    | 2024-03-20 | 营业中   | 赵六     | 13533334444
野百灵乐山店      | 乐山市 | 四川省 | 乐山市市中区嘉定路XX号      | 2024-05-10 | 营业中   | 钱七     | 13455556666
野百灵自贡店      | 自贡市 | 四川省 | 自贡市自流井区XX路XX号      | 2024-07-01 | 营业中   | 孙八     | 13677778888
```

### 数据规则

#### 1. 门店名称规则
- **必须唯一**: 不能有重复的门店名称
- **命名规范**: 品牌名 + 城市简称/区域 + "店"
  - ✅ 正确: `野百灵德阳店`
  - ✅ 正确: `野百灵成都春熙店`
  - ❌ 错误: `德阳店` (缺少品牌名)
  - ❌ 错误: `野百灵` (缺少城市和"店"字)

#### 2. 城市名称规范
- **必须带"市"**: `德阳市` 而非 `德阳`
- **标准化**: 使用民政部标准地名
- **一致性**: 同一城市的多个门店必须使用相同的城市名称

#### 3. 营业状态枚举值
- `营业中`: 正常营业
- `筹备中`: 正在筹备,尚未开业
- `暂停`: 临时停业
- `关闭`: 已关闭

#### 4. 日期格式
- **标准格式**: `YYYY-MM-DD`
- **示例**: `2023-06-01`
- **Excel设置**: 单元格格式 → 日期 → "2012-03-14"

### ETL处理规则

导入时系统会自动生成:

| 自动生成字段 | 生成规则 | 示例 |
|-------------|---------|------|
| store_code | 品牌简称-城市简称-流水号 | YBL-DY-001 |
| brand_id | 根据门店名称自动关联品牌 | 1 |
| business_status | 营业状态映射 | operating |

### 检查清单

导入前请确认:

- [ ] 共6行数据(不含表头)
- [ ] 门店名称无重复
- [ ] 城市名称统一带"市"
- [ ] 营业状态使用标准值
- [ ] 开业日期格式正确(YYYY-MM-DD)
- [ ] 无空白行

---

## 文件2: 成本卡配方数据

### 基本信息

- **文件名**: `成本卡_标准格式.xlsx`
- **文件格式**: Excel工作簿(.xlsx)
- **Sheet名称**: `产品配方明细`
- **数据行数**: 600-800行
- **编码格式**: UTF-8

### 必填字段定义

#### Sheet1: 产品配方明细

| 列序号 | 列名 | 数据类型 | 长度限制 | 示例值 | 是否必填 | 说明 |
|-------|------|---------|---------|--------|---------|------|
| A | 产品名称 | 文本 | 1-200字符 | 云山雪花吊龙 | ✅必填 | 成品或半成品名称 |
| B | 产品类型 | 文本 | - | 成品 | ✅必填 | 成品/半成品/原材料 |
| C | 品类 | 文本 | 1-200字符 | 肉类 | ✅必填 | 肉类/蔬菜类/调料类等 |
| D | 售卖价格 | 数值 | >0 | 68.00 | 条件必填 | 可销售产品必填 |
| E | 售卖份量 | 数值 | >0 | 250 | 条件必填 | 一份的量 |
| F | 份量单位 | 文本 | - | g | 条件必填 | g/ml/份/个等 |
| G | 原材料名称 | 文本 | 1-200字符 | 吊龙 | ✅必填 | 配方中的原材料 |
| H | 原材料品类 | 文本 | 1-200字符 | 肉类 | ✅必填 | 原材料所属品类 |
| I | 原材料理论单价 | 数值 | >0 | 48.00 | ✅必填 | 单价(元) |
| J | 单价单位 | 文本 | - | 元/斤 | ✅必填 | 元/斤、元/kg等 |
| K | 原材料理论用量 | 数值 | >0 | 250.00 | ✅必填 | 用量 |
| L | 用量单位 | 文本 | - | g | ✅必填 | g/ml/个等 |
| M | 原材料理论成本 | 数值 | ≥0 | 28.89 | ✅必填 | 小计成本(元) |
| N | 净货率 | 数值 | 0-1 | 0.95 | 推荐填 | 净货率(0-1) |
| O | 损耗率 | 数值 | 0-1 | 0.05 | 推荐填 | 损耗率(0-1) |

### 数据示例

```
产品名称     | 产品类型 | 品类 | 售卖价格 | 售卖份量 | 份量单位 | 原材料名称 | 原材料品类 | 原材料理论单价 | 单价单位 | 原材料理论用量 | 用量单位 | 原材料理论成本 | 净货率 | 损耗率
云山雪花吊龙 | 成品     | 肉类 | 68.00    | 250      | g        | 吊龙       | 肉类       | 48.00          | 元/斤    | 250.00         | g        | 24.00          | 0.95   | 0.05
云山雪花吊龙 | 成品     | 肉类 | 68.00    | 250      | g        | 小米辣     | 蔬菜类     | 8.00           | 元/斤    | 15.00          | g        | 0.24           | 1.00   | 0.00
云山雪花吊龙 | 成品     | 肉类 | 68.00    | 250      | g        | 香菜       | 蔬菜类     | 6.00           | 元/斤    | 10.00          | g        | 0.12           | 1.00   | 0.00
云山雪花吊龙 | 成品     | 肉类 | 68.00    | 250      | g        | 盐         | 调料类     | 3.00           | 元/斤    | 5.00           | g        | 0.03           | 1.00   | 0.00
贵州酸汤鱼   | 成品     | 鱼类 | 88.00    | 800      | g        | 罗非鱼     | 肉类       | 16.00          | 元/斤    | 500.00         | g        | 16.00          | 0.85   | 0.15
贵州酸汤鱼   | 成品     | 鱼类 | 88.00    | 800      | g        | 老凯里非遗酸汤 | 调料类 | 120.00         | 元/瓶    | 50.00          | g        | 6.00           | 1.00   | 0.00
...
```

### 数据规则

#### 1. 产品数据组织规则

**每个产品的所有原材料必须在连续的行中**

```
✅ 正确:
行1: 云山雪花吊龙 | 成品 | ... | 吊龙 | ...
行2: 云山雪花吊龙 | 成品 | ... | 小米辣 | ...
行3: 云山雪花吊龙 | 成品 | ... | 香菜 | ...
行4: 贵州酸汤鱼   | 成品 | ... | 罗非鱼 | ...

❌ 错误(中间被其他产品打断):
行1: 云山雪花吊龙 | 成品 | ... | 吊龙 | ...
行2: 贵州酸汤鱼   | 成品 | ... | 罗非鱼 | ...  ← 打断
行3: 云山雪花吊龙 | 成品 | ... | 小米辣 | ...
```

**产品基础信息(售卖价格、份量等)在每一行重复**

#### 2. 产品类型枚举值

| 产品类型 | 说明 | 示例 |
|---------|------|------|
| 成品 | 可销售的最终产品 | 云山雪花吊龙、贵州酸汤鱼 |
| 半成品 | 需要进一步加工的中间产品 | 水晶滑肉混合物、香茅酱 |
| 原材料 | 不可再分的基础原料 | 吊龙、小米辣、盐 |

#### 3. 品类标准值

**产品品类**:
- 肉类
- 蔬菜类
- 调料类
- 油类
- 半成品
- 成品菜
- 饮料

**原材料品类**:
- 肉类
- 蔬菜类
- 调料类
- 油类

#### 4. 单位标准化

**重量单位**:
- 克(g) - 基础单位 ⭐推荐
- 千克(kg)
- 斤
- 两
- 毫克(mg)
- 吨(t)

**体积单位**:
- 毫升(ml) - 基础单位 ⭐推荐
- 升(L)
- 加仑(gal)

**计数单位**:
- 个
- 瓶
- 袋
- 盒
- 件
- 包
- 罐
- 桶

**建议**: 配方用量统一使用 **g** 或 **ml** 作为基础单位

#### 5. 11个核心半成品清单

必须在成本卡中包含以下11个半成品的**完整分解**:

| 序号 | 半成品名称 | 必须有配方 |
|-----|-----------|----------|
| 1 | 水晶滑肉混合物 | ✅ |
| 2 | 香茅酱 | ✅ |
| 3 | 干巴菌酱 | ✅ |
| 4 | 青柠檬汁 | ✅ |
| 5 | 酸辣酱(罗非鱼用) | ✅ |
| 6 | 混合香草 | ✅ |
| 7 | 豆腐丸子蘸酱 | ✅ |
| 8 | 玉米糊 | ✅ |
| 9 | 怪噜洋芋酱 | ✅ |
| 10 | 紫苏汤 | ✅ |
| 11 | 老凯里非遗酸汤 | ✅ |

**完整分解**定义:
- 半成品的每个原材料都必须列出
- 如果半成品中包含其他半成品,需要继续分解到原材料
- 最终所有成分都是原材料(不可再分)

#### 6. 成本计算规则

**原材料理论成本计算公式**:

```
原材料理论成本 = (原材料理论用量 / 单价单位对应的量) × 原材料理论单价

示例:
原材料: 吊龙
单价: 48元/斤
用量: 250g
成本 = (250g / 500g) × 48元 = 24元
```

**产品总成本**:

```
产品总成本 = Σ(所有原材料理论成本)

示例:
云山雪花吊龙总成本 = 24.00 + 0.24 + 0.12 + 0.03 + ... = 30.71元
```

#### 7. 净货率和损耗率

- **净货率**: 原材料加工后可用部分的比例
  - 示例: 1斤带皮土豆,去皮后0.85斤,净货率 = 0.85
  - 范围: 0-1之间的小数

- **损耗率**: 加工过程中的损耗比例
  - 示例: 1斤蔬菜,摘洗后损失0.1斤,损耗率 = 0.1
  - 范围: 0-1之间的小数
  - 关系: 损耗率 = 1 - 净货率

### Sheet2: 11个核心半成品清单(可选)

如果提供此sheet,便于快速核对:

| 半成品名称 | 是否已有配方 | 备注 |
|-----------|------------|------|
| 水晶滑肉混合物 | 是 | |
| 香茅酱 | 是 | |
| 干巴菌酱 | 是 | |
| 青柠檬汁 | 是 | |
| 酸辣酱(罗非鱼用) | 是 | |
| 混合香草 | 是 | |
| 豆腐丸子蘸酱 | 是 | |
| 玉米糊 | 是 | |
| 怪噜洋芋酱 | 是 | |
| 紫苏汤 | 是 | |
| 老凯里非遗酸汤 | 是 | |

### ETL处理规则

导入时系统会:

1. **自动生成产品编码**:
   - 成品: FIN-001, FIN-002, ...
   - 半成品: SEMI-001, SEMI-002, ...
   - 原材料: RAW-001, RAW-002, ...

2. **自动标记核心半成品**:
   - 11个半成品自动设置 `is_core_semi_finished = TRUE`

3. **自动加密成本**:
   - 原材料理论单价 → 加密存储
   - 原材料理论成本 → 加密存储
   - 产品总成本 → 加密存储

4. **自动单位换算**:
   - 建立单位换算关系(斤→g, 瓶→ml等)
   - 统一配方用量单位为基础单位(g/ml)

### 检查清单

导入前请确认:

- [ ] 共63个产品(成品+半成品)
- [ ] 每个产品至少有1条原材料记录
- [ ] 11个核心半成品都在列表中
- [ ] 11个半成品都有完整的配方分解
- [ ] 所有原材料都有单价
- [ ] 可销售产品的售卖价格、份量、单位都已填写
- [ ] 原材料理论成本 = (用量/单价单位量) × 单价
- [ ] 同一产品的所有原材料在连续的行中
- [ ] 无空白行
- [ ] 数值字段无文字(如"约48元"应改为"48")

---

## 文件3: 销售明细数据

### 基本信息

- **文件名**: `销售明细_测试数据.xlsx`
- **文件格式**: Excel工作簿(.xlsx)
- **Sheet名称**: `销售明细`
- **数据行数**: 3,000-10,000行(1个月数据)
- **编码格式**: UTF-8
- **测试范围**: 德阳店2025年9月

### 必填字段定义

| 列序号 | 列名 | 数据类型 | 长度限制 | 示例值 | 是否必填 | 说明 |
|-------|------|---------|---------|--------|---------|------|
| A | 门店名称 | 文本 | 1-200字符 | 野百灵德阳店 | ✅必填 | 必须与门店信息表完全一致 |
| B | 销售日期 | 日期 | YYYY-MM-DD | 2025-09-01 | ✅必填 | 销售发生日期 |
| C | 销售时间 | 时间 | HH:MM:SS | 12:30:00 | 可选 | 销售发生时间 |
| D | 时段 | 文本 | - | 午市 | 可选 | 午市/晚市/夜宵 |
| E | 产品名称 | 文本 | 1-200字符 | 云山雪花吊龙 | ✅必填 | **必须与成本卡产品名称完全一致** |
| F | 销售数量 | 数值 | >0 | 2 | ✅必填 | 销售份数 |
| G | **销售额(折前)** | 数值 | ≥0 | 136.00 | ✅✅必填 | ⭐折扣前的销售额 |
| H | **菜品收入(折后)** | 数值 | ≥0 | 122.40 | ✅✅必填 | ⭐折扣后的实际收入 |
| I | **菜品优惠** | 数值 | ≥0 | 13.60 | ✅✅必填 | ⭐优惠金额 |
| J | 优惠率 | 数值 | 0-100 | 10.00 | 推荐填 | 优惠百分比 |
| K | 支付方式 | 文本 | - | 微信 | 可选 | 微信/支付宝/现金/银行卡 |

### 数据示例

```
门店名称     | 销售日期   | 销售时间 | 时段 | 产品名称     | 销售数量 | 销售额(折前) | 菜品收入(折后) | 菜品优惠 | 优惠率 | 支付方式
野百灵德阳店 | 2025-09-01 | 12:30:00 | 午市 | 云山雪花吊龙 | 2        | 136.00       | 122.40         | 13.60    | 10.00  | 微信
野百灵德阳店 | 2025-09-01 | 12:35:00 | 午市 | 贵州酸汤鱼   | 1        | 88.00        | 88.00          | 0.00     | 0.00   | 支付宝
野百灵德阳店 | 2025-09-01 | 13:15:00 | 午市 | 云山雪花吊龙 | 1        | 68.00        | 61.20          | 6.80     | 10.00  | 微信
野百灵德阳店 | 2025-09-01 | 18:20:00 | 晚市 | 云山雪花吊龙 | 3        | 204.00       | 183.60         | 20.40    | 10.00  | 微信
野百灵德阳店 | 2025-09-01 | 18:25:00 | 晚市 | 贵州酸汤鱼   | 2        | 176.00       | 158.40         | 17.60    | 10.00  | 银行卡
野百灵德阳店 | 2025-09-01 | 19:00:00 | 晚市 | 特色小炒肉   | 1        | 48.00        | 48.00          | 0.00     | 0.00   | 现金
...
```

### 数据规则

#### 1. 门店名称规则

**必须与文件1(门店信息)中的门店名称完全一致**

```
✅ 正确:
门店信息表: 野百灵德阳店
销售明细表: 野百灵德阳店  ← 完全一致

❌ 错误(多余空格):
门店信息表: 野百灵德阳店
销售明细表: 野百灵 德阳店  ← 中间有空格

❌ 错误(简写):
门店信息表: 野百灵德阳店
销售明细表: 德阳店  ← 缺少品牌名
```

#### 2. 产品名称规则

**必须与文件2(成本卡)中的产品名称完全一致**

```
✅ 正确:
成本卡:   云山雪花吊龙
销售明细: 云山雪花吊龙  ← 完全一致

❌ 错误(括号不一致):
成本卡:   酸辣酱(罗非鱼用)  ← 半角括号
销售明细: 酸辣酱(罗非鱼用)  ← 全角括号

❌ 错误(多余空格):
成本卡:   云山雪花吊龙
销售明细: 云山 雪花吊龙  ← 中间有空格

❌ 错误(别名):
成本卡:   贵州酸汤鱼
销售明细: 酸汤鱼  ← 缺少"贵州"
```

#### 3. 三个金额字段的关系 ⭐关键规则

**必须满足计算关系**:

```
销售额(折前) - 菜品优惠 = 菜品收入(折后)
```

**示例**:

| 场景 | 销售额(折前) | 菜品优惠 | 菜品收入(折后) | 是否正确 |
|------|-------------|---------|---------------|---------|
| 无优惠 | 68.00 | 0.00 | 68.00 | ✅ 正确 |
| 9折优惠 | 68.00 | 6.80 | 61.20 | ✅ 正确 |
| 直减10元 | 68.00 | 10.00 | 58.00 | ✅ 正确 |
| 错误示例 | 68.00 | 6.80 | 68.00 | ❌ 错误(折后应该是61.20) |
| 错误示例 | 68.00 | -6.80 | 74.80 | ❌ 错误(优惠不能是负数) |

**验证公式** (Excel):
```excel
=IF(ABS((G2-I2)-H2)>0.01, "错误", "正确")
```
其中: G=销售额(折前), H=菜品收入(折后), I=菜品优惠

#### 4. 日期时间格式

**销售日期**:
- 格式: `YYYY-MM-DD`
- 示例: `2025-09-01`
- Excel设置: 单元格格式 → 日期 → "2012-03-14"

**销售时间**(可选):
- 格式: `HH:MM:SS`
- 示例: `12:30:00`
- Excel设置: 单元格格式 → 时间 → "13:30:55"

#### 5. 时段枚举值(可选)

| 时段 | 时间范围 | 说明 |
|-----|---------|------|
| 午市 | 10:30-14:00 | 午餐时段 |
| 晚市 | 17:00-21:00 | 晚餐时段 |
| 夜宵 | 21:00-02:00 | 夜宵时段 |

#### 6. 支付方式枚举值(可选)

- 微信
- 支付宝
- 现金
- 银行卡
- 会员卡

### ETL处理规则

导入时系统会:

1. **自动匹配门店**: 根据门店名称关联store_id
2. **自动匹配产品**: 根据产品名称关联product_id
3. **自动关联配方**: 根据product_id找到当前配方recipe_id
4. **自动计算成本率**(GENERATED列):
   - theoretical_cost = 销售数量 × 配方单品成本
   - standard_cost_rate = (theoretical_cost / 销售额(折前)) × 100%
   - **actual_cost_rate** = (theoretical_cost / 菜品收入(折后)) × 100% ⭐核心
   - cost_variance = actual_cost_rate - standard_cost_rate
   - gross_margin_rate = ((菜品收入 - theoretical_cost) / 菜品收入) × 100%

### 检查清单

导入前请确认:

- [ ] 门店名称与门店信息表完全一致
- [ ] 产品名称与成本卡完全一致
- [ ] 三个金额字段都有值(无优惠时优惠填0)
- [ ] 金额计算关系正确: 折前 - 优惠 = 折后
- [ ] 销售数量都大于0
- [ ] 日期格式正确(YYYY-MM-DD)
- [ ] 无空白行
- [ ] 测试数据为1个月(德阳店2025年9月)

---

## 文件4: 数据库配置

### 基本信息

- **文件名**: `数据库配置.txt`
- **文件格式**: INI配置文件(.txt)
- **编码格式**: UTF-8

### 配置内容

```ini
[database]
# 数据库连接信息
host = localhost
port = 5432
database = ybl_restaurant
user = postgres
password = your_password_here

[encryption]
# 成本数据加密密钥(至少32个字符)
# 注意: 此密钥必须妥善保管,丢失后无法解密历史数据!
key = ybl-restaurant-2025-encryption-key-secure-password-32chars

[etl]
# ETL导入配置
batch_size = 1000
validation_level = strict
auto_generate_code = true

# 产品编码前缀
code_prefix_finished = FIN
code_prefix_semi = SEMI
code_prefix_raw = RAW

# 门店编码前缀
store_code_prefix = YBL

[brand]
# 默认品牌信息
default_brand_code = YBL
default_brand_name = 野百灵贵州酸汤
```

### 配置说明

#### [database] 数据库连接

| 参数 | 说明 | 示例 |
|-----|------|------|
| host | 数据库服务器地址 | localhost(本机) / 192.168.1.100(远程) |
| port | 数据库端口 | 5432(PostgreSQL默认端口) |
| database | 数据库名称 | ybl_restaurant |
| user | 数据库用户名 | postgres |
| password | 数据库密码 | 您的实际密码 |

#### [encryption] 加密配置

| 参数 | 说明 | 要求 |
|-----|------|------|
| key | 加密密钥 | 至少32个字符,建议包含大小写字母+数字+特殊符号 |

⚠️ **重要提醒**:
- 加密密钥必须妥善保管
- 密钥丢失后,所有历史成本数据将无法解密
- 建议备份密钥到安全位置

#### [etl] ETL配置

| 参数 | 说明 | 默认值 |
|-----|------|-------|
| batch_size | 批量导入的记录数 | 1000 |
| validation_level | 验证级别 | strict(严格) / normal(普通) |
| auto_generate_code | 是否自动生成编码 | true |
| code_prefix_* | 各类产品编码前缀 | FIN/SEMI/RAW |

---

## 数据质量检查

### Excel自检公式

#### 检查1: 产品名称一致性

**目的**: 检查销售明细中的产品是否都在成本卡中

**Excel公式**:
```excel
// 在销售明细表的空白列添加
=IF(COUNTIF(成本卡!$A:$A, E2)>0, "✓", "✗产品不存在")
```

**操作步骤**:
1. 打开"销售明细_测试数据.xlsx"
2. 在产品名称列(E列)右侧新增一列
3. 输入上述公式
4. 下拉填充所有行
5. 筛选出"✗产品不存在"的记录进行修正

---

#### 检查2: 门店名称一致性

**目的**: 检查销售明细中的门店是否都在门店信息表中

**Excel公式**:
```excel
// 在销售明细表的空白列添加
=IF(COUNTIF(门店信息!$A:$A, A2)>0, "✓", "✗门店不存在")
```

---

#### 检查3: 金额计算正确性

**目的**: 检查销售额(折前) - 菜品优惠 = 菜品收入(折后)

**Excel公式**:
```excel
// 在销售明细表的空白列添加
=IF(ABS((G2-I2)-H2)>0.01, "✗金额错误", "✓")
```

其中:
- G列 = 销售额(折前)
- H列 = 菜品收入(折后)
- I列 = 菜品优惠

---

#### 检查4: 半成品完整性

**目的**: 确认11个核心半成品在成本卡中都有配方

**手动检查清单**:

| 序号 | 半成品名称 | 是否在成本卡中 | 是否有配方明细 |
|-----|-----------|--------------|---------------|
| 1 | 水晶滑肉混合物 | [ ] | [ ] |
| 2 | 香茅酱 | [ ] | [ ] |
| 3 | 干巴菌酱 | [ ] | [ ] |
| 4 | 青柠檬汁 | [ ] | [ ] |
| 5 | 酸辣酱(罗非鱼用) | [ ] | [ ] |
| 6 | 混合香草 | [ ] | [ ] |
| 7 | 豆腐丸子蘸酱 | [ ] | [ ] |
| 8 | 玉米糊 | [ ] | [ ] |
| 9 | 怪噜洋芋酱 | [ ] | [ ] |
| 10 | 紫苏汤 | [ ] | [ ] |
| 11 | 老凯里非遗酸汤 | [ ] | [ ] |

---

#### 检查5: 数值字段纯净性

**目的**: 确保数值字段不包含文字

**常见错误**:

| 字段 | 错误示例 | 正确示例 |
|-----|---------|---------|
| 原材料理论单价 | "约48元" | 48.00 |
| 原材料理论单价 | "48元/斤" | 48.00 |
| 销售数量 | "2份" | 2 |
| 菜品优惠 | "无" | 0.00 |

**检查方法**: 在Excel中选中数值列 → 开始 → 查找和替换 → 查找 → 选项 → 格式 → 数字 → 常规

---

### 数据完整性检查

#### 产品维度检查

```sql
-- 检查SQL(导入后执行)
-- 检查是否有产品缺少配方
SELECT p.product_name
FROM product p
LEFT JOIN recipe r ON p.product_id = r.product_id AND r.is_current = TRUE
WHERE p.product_type IN ('finished', 'semi_finished')
  AND r.recipe_id IS NULL;

-- 应该返回0行
```

#### 门店维度检查

```sql
-- 检查是否所有门店都有销售数据
SELECT s.store_name, COUNT(sd.sales_detail_id) AS sales_count
FROM store s
LEFT JOIN sales_detail sd ON s.store_id = sd.store_id
GROUP BY s.store_name;

-- 至少德阳店应该有销售数据
```

---

## 常见问题与解决方案

### 问题1: 括号不一致导致产品匹配失败

**现象**:
```
成本卡中有:   酸辣酱(罗非鱼用)
销售表中有:   酸辣酱(罗非鱼用)
结果: 无法匹配,提示"产品不存在"
```

**原因**: 括号类型不一致
- 成本卡使用: 半角括号 `()`
- 销售表使用: 全角括号 `()`

**解决方案**:
1. **方案A**: 统一使用半角括号 `()`(推荐)
   - 在Excel中: Ctrl+H → 查找`(` → 替换为`(`
   - 查找`(` → 替换为`)`

2. **方案B**: ETL脚本自动处理(由我在脚本中实现)

---

### 问题2: 多余空格导致匹配失败

**现象**:
```
成本卡:   云山雪花吊龙
销售表:   云山 雪花吊龙    (中间多了空格)
结果: 无法匹配
```

**解决方案**:
1. **Excel清理**: 选中列 → Ctrl+H → 查找`  `(两个空格) → 替换为` `(一个空格) → 全部替换
2. **Excel函数**: `=TRIM(A2)` 去除多余空格

---

### 问题3: 金额计算不平

**现象**:
```
销售额(折前): 136.00
菜品优惠: 13.60
菜品收入(折后): 122.50  ← 错误,应该是122.40
```

**原因**: 手动录入或计算错误

**解决方案**:
1. 使用Excel公式自动计算:
   ```excel
   // H列(菜品收入) = G列(销售额) - I列(优惠)
   =G2-I2
   ```
2. 设置单元格格式为数值,保留2位小数

---

### 问题4: 产品名称缺失

**现象**:
```
销售表中有: "特色烤鱼"
成本卡中无: "特色烤鱼"
结果: 提示"产品不存在"
```

**解决方案**:
1. **方案A**: 在成本卡中补充"特色烤鱼"的配方
2. **方案B**: 从销售表中删除"特色烤鱼"的记录(如果已下架)
3. **方案C**: 修改销售表中的产品名称为成本卡中的正确名称

---

### 问题5: 优惠金额为负数

**现象**:
```
菜品优惠: -10.00
```

**原因**: 可能是退货/退款记录,或者Excel公式错误

**解决方案**:
1. 优惠金额必须≥0
2. 如果是退货,应该:
   - 销售数量为负数: -1
   - 销售额和收入也为负数

---

### 问题6: 日期格式错误

**现象**:
```
销售日期: 2025/9/1    ← 错误格式
销售日期: 09-01       ← 缺少年份
```

**解决方案**:
1. 统一使用格式: `YYYY-MM-DD`
2. Excel设置: 选中日期列 → 右键 → 设置单元格格式 → 日期 → "2012-03-14"

---

## 导入流程

### 第一阶段: 准备阶段(您负责)

#### 步骤1: 整理门店信息(30分钟)

- [ ] 创建`门店信息.xlsx`
- [ ] 填写6个门店的完整信息
- [ ] 检查门店名称无重复
- [ ] 检查城市名称格式统一

#### 步骤2: 整理成本卡(1-2小时)

- [ ] 复制现有成本卡到`成本卡_标准格式.xlsx`
- [ ] 调整列顺序与标准格式一致
- [ ] 确认63个产品都有配方
- [ ] 确认11个半成品都有完整分解
- [ ] 运行Excel检查公式

#### 步骤3: 提取销售数据(30分钟)

- [ ] 从销售系统导出2025年9月数据
- [ ] 复制到`销售明细_测试数据.xlsx`
- [ ] 调整列顺序与标准格式一致
- [ ] 确认三个金额字段都有
- [ ] 运行Excel检查公式

#### 步骤4: 配置数据库(15分钟)

- [ ] 创建`数据库配置.txt`
- [ ] 填写数据库连接信息
- [ ] 设置加密密钥(至少32字符)
- [ ] 备份配置文件

---

### 第二阶段: 导入阶段(我负责编写脚本)

#### 脚本1: etl_1_import_master_data.py

**功能**: 导入基础数据(品牌、门店、产品)

**输入文件**:
- 门店信息.xlsx
- 成本卡_标准格式.xlsx(仅读取产品列表)

**输出**:
- brand表: 2条记录
- store表: 6条记录
- product_category表: 7条记录
- product表: 200-300条记录
- unit_of_measure表: 17条记录
- unit_conversion表: 50+条记录

**执行时间**: 约2分钟

---

#### 脚本2: etl_2_import_recipe.py

**功能**: 导入配方数据

**输入文件**:
- 成本卡_标准格式.xlsx

**输出**:
- recipe表: 63条记录
- recipe_item表: 600-800条记录
- ingredient_cost_history表: 150-200条记录

**特殊处理**:
- 自动识别11个核心半成品
- 成本字段自动加密
- BOM完全分解验证

**执行时间**: 约3-5分钟

---

#### 脚本3: etl_3_import_sales.py

**功能**: 导入销售数据

**输入文件**:
- 销售明细_测试数据.xlsx

**流程**:
1. 读取Excel → staging_sales_detail临时表
2. 执行5轮验证:
   - Round 1: 数据提取验证
   - Round 2: 结构验证
   - Round 3: 计算验证
   - Round 4: 逻辑验证
   - Round 5: 质量评分
3. 生成验证报告
4. 人工审核
5. 审核通过 → 迁移到sales_detail表
6. 自动计算成本率(GENERATED列)

**执行时间**: 约5-10分钟

---

#### 脚本4: verify_dual_cost_rate.py

**功能**: 验证双成本率计算

**验证内容**:
- 理论成本计算正确性
- 标准成本率计算正确性
- 实际成本率计算正确性
- 成本率差异计算正确性
- 毛利率计算正确性

**输出**: 验证报告.md

---

### 第三阶段: 验证阶段(一起完成)

#### 验证1: 数据完整性

```sql
-- 检查各表记录数
SELECT 'brand' AS table_name, COUNT(*) AS count FROM brand
UNION ALL
SELECT 'store', COUNT(*) FROM store
UNION ALL
SELECT 'product', COUNT(*) FROM product
UNION ALL
SELECT 'recipe', COUNT(*) FROM recipe
UNION ALL
SELECT 'recipe_item', COUNT(*) FROM recipe_item
UNION ALL
SELECT 'sales_detail', COUNT(*) FROM sales_detail;
```

**预期结果**:
- brand: 2
- store: 6
- product: 200-300
- recipe: 63
- recipe_item: 600-800
- sales_detail: 3,000-10,000

---

#### 验证2: 双成本率计算

```sql
-- 查询双成本率
SELECT
    store_name,
    product_name,
    total_quantity,
    total_presales,
    total_revenue,
    total_discount,
    total_theoretical_cost,
    standard_cost_rate,
    actual_cost_rate,
    cost_rate_variance,
    actual_gross_margin_rate
FROM v_sales_summary_dual_cost_rate
WHERE year_month = '2025-09'
  AND store_name = '野百灵德阳店'
ORDER BY total_revenue DESC
LIMIT 10;
```

**手动验证**: 抽查3-5个产品,用Excel手动计算验证

---

#### 验证3: BOM分解

```sql
-- 测试BOM分解函数
SELECT * FROM explode_bom(
    (SELECT product_id FROM product WHERE product_name = '云山雪花吊龙'),
    1.0,
    1
);
```

**预期结果**: 应该分解到所有原材料,无半成品

---

### 第四阶段: 全量导入(测试通过后)

- [ ] 导入德阳店10月数据
- [ ] 导入绵阳店8-10月数据
- [ ] 导入其他4个门店数据
- [ ] 生成完整双成本率分析报告

---

## 附录

### 附录A: 单位换算表

| 从单位 | 到单位 | 换算系数 |
|-------|--------|---------|
| kg | g | 1000 |
| 斤 | g | 500 |
| 两 | g | 50 |
| 吨 | kg | 1000 |
| L | ml | 1000 |
| 加仑 | ml | 3785.4 |

### 附录B: 品类枚举值

**产品品类**:
- 肉类
- 蔬菜类
- 调料类
- 油类
- 半成品
- 成品菜
- 饮料

### 附录C: 字段映射关系

**销售明细 → 数据库字段**:

| Excel列名 | 数据库字段名 | 数据类型 |
|----------|------------|---------|
| 门店名称 | store_id (关联) | INT |
| 销售日期 | sales_date | DATE |
| 销售时间 | sales_time | TIME |
| 时段 | time_slot | VARCHAR |
| 产品名称 | product_id (关联) | INT |
| 销售数量 | sales_quantity | DECIMAL |
| 销售额(折前) | presales_amount | DECIMAL |
| 菜品收入(折后) | product_revenue | DECIMAL |
| 菜品优惠 | product_discount | DECIMAL |
| 优惠率 | discount_rate | DECIMAL |
| 支付方式 | payment_method | VARCHAR |

---

## 文档版本历史

| 版本 | 日期 | 修改内容 | 修改人 |
|-----|------|---------|--------|
| v1.0.0 | 2025-11-21 | 初始版本 | Claude |

---

**文档结束**

如有疑问,请联系技术支持。
